#!/usr/bin/env bash
set -euo pipefail

# Resolve script directory (exported for config.sh)
export _BWS_SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
SCRIPT_DIR="$_BWS_SCRIPT_DIR"

bws::check_deps() {
    local missing=()
    command -v yq &>/dev/null || missing+=("yq")
    command -v gum &>/dev/null || missing+=("gum (optional, for interactive selection)")

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Missing dependencies:" >&2
        printf '  - %s\n' "${missing[@]}" >&2
        [[ " ${missing[*]} " == *" yq "* ]] && return $BWS_EXIT_ERROR
    fi
    return $BWS_EXIT_SUCCESS
}

# Source libraries
source "$SCRIPT_DIR/lib/exitcodes.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/query.sh"
source "$SCRIPT_DIR/lib/validate.sh"
source "$SCRIPT_DIR/lib/ui.sh"

# Source command handlers
source "$SCRIPT_DIR/commands/project.sh"
source "$SCRIPT_DIR/commands/task.sh"
source "$SCRIPT_DIR/commands/task-spec.sh"
source "$SCRIPT_DIR/commands/is-blocked.sh"

bws::check_deps || exit $BWS_EXIT_ERROR

# Resource-level help functions
bws::help::project() {
    cat <<EOF
Usage: bws project <action> [args] [flags]

Actions:
  list    List all projects
  get     Get project details

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --min-priority=X   Filter by minimum priority (0-4, 0=critical)

Examples:
  bws project list --status=in_progress
  bws project get my-project
EOF
}

bws::help::task() {
    cat <<EOF
Usage: bws task <action> [args] [flags]

Actions:
  list    List tasks in a project
  get     Get task details

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --min-priority=X   Filter by minimum priority (0-4, 0=critical)

Examples:
  bws task list my-project --status=backlog
  bws task get my-project/my-task
EOF
}

bws::help::task_spec() {
    cat <<EOF
Usage: bws task-spec <action> [args]

Actions:
  get     Get task specification (SPEC.md)

Examples:
  bws task-spec get my-project/my-task
EOF
}

bws::help::is_blocked() {
    cat <<EOF
Usage: bws is-blocked <task-id>

Check if a task is blocked by incomplete dependencies.

Exit codes:
  0 - Task is blocked
  1 - Task is not blocked

Examples:
  bws is-blocked my-project/my-task
EOF
}

# Action-level help functions
bws::help::project::list() {
    cat <<EOF
Usage: bws project list [flags]

List all projects with optional filtering.

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --min-priority=X   Filter by minimum priority (0-4, 0=critical)

Examples:
  bws project list
  bws project list --status=in_progress
  bws project list --min-priority=2
EOF
}

bws::help::project::get() {
    cat <<EOF
Usage: bws project get [project-id]

Get details for a specific project. If no project-id is provided,
an interactive selector will be shown.

Examples:
  bws project get my-project
  bws project get
EOF
}

bws::help::task::list() {
    cat <<EOF
Usage: bws task list [project-id] [flags]

List tasks within a project. If no project-id is provided,
an interactive selector will be shown.

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --min-priority=X   Filter by minimum priority (0-4, 0=critical)

Examples:
  bws task list my-project
  bws task list my-project --status=backlog
  bws task list --min-priority=1
EOF
}

bws::help::task::get() {
    cat <<EOF
Usage: bws task get [task-id]

Get details for a specific task. If no task-id is provided,
an interactive selector will be shown.

Task ID format: project-id/task-slug

Examples:
  bws task get my-project/my-task
  bws task get
EOF
}

bws::help::task_spec::get() {
    cat <<EOF
Usage: bws task-spec get [task-id]

Get the specification (SPEC.md) for a task. If no task-id is provided,
an interactive selector will be shown.

Task ID format: project-id/task-slug

Examples:
  bws task-spec get my-project/my-task
  bws task-spec get
EOF
}

# Helper to check if args contain --help
bws::has_help_flag() {
    for arg in "$@"; do
        case "$arg" in
            --help|-h) return $BWS_EXIT_SUCCESS ;;
        esac
    done
    return $BWS_EXIT_ERROR
}

bws::main() {
    local resource="${1:-}"
    local action="${2:-}"
    shift 2 2>/dev/null || true

    case "$resource" in
        project)
            case "$action" in
                --help|-h|"") bws::help::project; return $BWS_EXIT_SUCCESS ;;
                list)
                    if bws::has_help_flag "$@"; then bws::help::project::list; return $BWS_EXIT_SUCCESS
                    else bws::cmd::project::list "$@"; return $?; fi
                    ;;
                get)
                    if bws::has_help_flag "$@"; then bws::help::project::get; return $BWS_EXIT_SUCCESS
                    else bws::cmd::project::get "$@"; return $?; fi
                    ;;
                *)
                    echo "Unknown action: $action" >&2
                    bws::help::project
                    return $BWS_EXIT_ERROR
                    ;;
            esac
            ;;
        task)
            case "$action" in
                --help|-h|"") bws::help::task; return $BWS_EXIT_SUCCESS ;;
                list)
                    if bws::has_help_flag "$@"; then bws::help::task::list; return $BWS_EXIT_SUCCESS
                    else bws::cmd::task::list "$@"; return $?; fi
                    ;;
                get)
                    if bws::has_help_flag "$@"; then bws::help::task::get; return $BWS_EXIT_SUCCESS
                    else bws::cmd::task::get "$@"; return $?; fi
                    ;;
                *)
                    echo "Unknown action: $action" >&2
                    bws::help::task
                    return $BWS_EXIT_ERROR
                    ;;
            esac
            ;;
        task-spec)
            case "$action" in
                --help|-h|"") bws::help::task_spec; return $BWS_EXIT_SUCCESS ;;
                get)
                    if bws::has_help_flag "$@"; then bws::help::task_spec::get; return $BWS_EXIT_SUCCESS
                    else bws::cmd::task_spec::get "$@"; return $?; fi
                    ;;
                *)
                    echo "Unknown action: $action" >&2
                    bws::help::task_spec
                    return $BWS_EXIT_ERROR
                    ;;
            esac
            ;;
        is-blocked)
            # is-blocked has no actions - $action is the task-id
            if [[ "$action" == "--help" || "$action" == "-h" ]]; then
                bws::help::is_blocked
                return $BWS_EXIT_SUCCESS
            elif bws::has_help_flag "$@"; then
                bws::help::is_blocked
                return $BWS_EXIT_SUCCESS
            else
                bws::cmd::is_blocked "$action" "$@"
                return $?
            fi
            ;;
        --help|-h|"")
            bws::usage
            return $BWS_EXIT_SUCCESS
            ;;
        *)
            echo "Unknown resource: $resource" >&2
            bws::usage
            return $BWS_EXIT_ERROR
            ;;
    esac
}

bws::usage() {
    cat <<EOF
Usage: bws <resource> <action> [args] [flags]

Resources:
  project         Manage projects
    list          List projects [--status=X] [--min-priority=X]
    get           Get project details [project-id]

  task            Manage tasks
    list          List tasks [project-id] [--status=X] [--min-priority=X]
    get           Get task details [task-id]

  task-spec       View task specifications
    get           Get task spec [task-id]

  is-blocked      Check if task is blocked <task-id>

Flags:
  --status=X         backlog | discovery | in_progress | review | done
  --min-priority=X   0 (critical) to 4 (backlog)

Run 'bws <resource> --help' for resource-specific help.
EOF
}

bws::main "$@"
