#!/usr/bin/env bash
set -euo pipefail

# Resolve script directory, following symlinks (exported for config.sh)
export _REPP_SCRIPT_DIR="$(cd "$(dirname "$(readlink -f "${BASH_SOURCE[0]}")")" && pwd)"
SCRIPT_DIR="$_REPP_SCRIPT_DIR"

repp::check_deps() {
    local missing=()
    command -v yq &>/dev/null || missing+=("yq")
    command -v gum &>/dev/null || missing+=("gum (optional, for interactive selection)")

    if [[ ${#missing[@]} -gt 0 ]]; then
        echo "Missing dependencies:" >&2
        printf '  - %s\n' "${missing[@]}" >&2
        [[ " ${missing[*]} " == *" yq "* ]] && return $REPP_EXIT_ERROR
    fi
    return $REPP_EXIT_SUCCESS
}

# Source libraries
source "$SCRIPT_DIR/lib/exitcodes.sh"
source "$SCRIPT_DIR/lib/log.sh"
source "$SCRIPT_DIR/lib/config.sh"
source "$SCRIPT_DIR/lib/query.sh"
source "$SCRIPT_DIR/lib/validate.sh"
source "$SCRIPT_DIR/lib/ui.sh"
source "$SCRIPT_DIR/lib/mutate.sh"

# Source command handlers
source "$SCRIPT_DIR/commands/plan.sh"

repp::check_deps || exit $REPP_EXIT_ERROR

# Resource-level help functions
repp::help::plan() {
    cat <<EOF
Usage: repp plan <action> [args] [flags]

Actions:
  list        List all plans
  get         Get plan details
  scan        List plan IDs only
  prioritize  Set plan priority
  review      Transition plan to review
  complete    Transition plan to done
  note        Add comment to plan
  is-blocked  Check if plan is blocked

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --priority=X,Y,... Filter by priority (exact match, comma-separated)

Examples:
  repp plan list --status=in_progress
  repp plan get my-plan
  repp plan prioritize my-plan P1
  repp plan note my-plan "test comment"
EOF
}

# Action-level help functions
repp::help::plan::list() {
    cat <<EOF
Usage: repp plan list [flags]

List all plans with optional filtering.

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --priority=X,Y,... Filter by priority (exact match, comma-separated)

Examples:
  repp plan list
  repp plan list --status=in_progress
  repp plan list --priority=1,2
EOF
}

repp::help::plan::get() {
    cat <<EOF
Usage: repp plan get [plan-id]

Get details for a specific plan. If no plan-id is provided,
an interactive selector will be shown.

Examples:
  repp plan get my-plan
  repp plan get
EOF
}

repp::help::plan::scan() {
    cat <<EOF
Usage: repp plan scan [flags]

List plan IDs only (no file contents).

Flags:
  --status=X         Filter by status (backlog|discovery|in_progress|review|done)
  --priority=X,Y,... Filter by priority (exact match, comma-separated)

Examples:
  repp plan scan
  repp plan scan --status=in_progress
EOF
}

repp::help::plan::prioritize() {
    cat <<EOF
Usage: repp plan prioritize [plan-id] [priority]

Set plan priority. If no plan-id is provided, an interactive
selector will be shown.

Priority: Any alphanumeric value (e.g., 1, 01, P1, high)

Examples:
  repp plan prioritize my-plan 1
  repp plan prioritize my-plan P1
  repp plan prioritize
EOF
}

repp::help::plan::review() {
    cat <<EOF
Usage: repp plan review [plan-id]

Transition plan status to review. If no plan-id is provided,
an interactive selector will be shown.

Examples:
  repp plan review my-plan
  repp plan review
EOF
}

repp::help::plan::complete() {
    cat <<EOF
Usage: repp plan complete [plan-id]

Transition plan status to done. If no plan-id is provided,
an interactive selector will be shown.

Examples:
  repp plan complete my-plan
  repp plan complete
EOF
}

repp::help::plan::note() {
    cat <<EOF
Usage: repp plan note [plan-id] [comment]

Add a comment to the plan. If no plan-id is provided,
an interactive selector will be shown.

Examples:
  repp plan note my-plan "Waiting on API team"
  repp plan note
EOF
}

repp::help::plan::is_blocked() {
    cat <<EOF
Usage: repp plan is-blocked <plan-id>

Check if a plan is blocked by incomplete dependencies.

Exit codes:
  0 - Plan is blocked
  1 - Plan is not blocked

Examples:
  repp plan is-blocked my-plan
EOF
}

# Helper to check if args contain --help
repp::has_help_flag() {
    for arg in "$@"; do
        case "$arg" in
            --help|-h) return $REPP_EXIT_SUCCESS ;;
        esac
    done
    return $REPP_EXIT_ERROR
}

repp::main() {
    local resource="${1:-}"
    local action="${2:-}"
    shift 2 2>/dev/null || true

    case "$resource" in
        plan)
            case "$action" in
                --help|-h|"") repp::help::plan; return $REPP_EXIT_SUCCESS ;;
                list)
                    if repp::has_help_flag "$@"; then repp::help::plan::list; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::list "$@"; return $?; fi
                    ;;
                get)
                    if repp::has_help_flag "$@"; then repp::help::plan::get; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::get "$@"; return $?; fi
                    ;;
                scan)
                    if repp::has_help_flag "$@"; then repp::help::plan::scan; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::scan "$@"; return $?; fi
                    ;;
                prioritize)
                    if repp::has_help_flag "$@"; then repp::help::plan::prioritize; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::prioritize "$@"; return $?; fi
                    ;;
                review)
                    if repp::has_help_flag "$@"; then repp::help::plan::review; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::review "$@"; return $?; fi
                    ;;
                complete)
                    if repp::has_help_flag "$@"; then repp::help::plan::complete; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::complete "$@"; return $?; fi
                    ;;
                note)
                    if repp::has_help_flag "$@"; then repp::help::plan::note; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::note "$@"; return $?; fi
                    ;;
                is-blocked)
                    if repp::has_help_flag "$@"; then repp::help::plan::is_blocked; return $REPP_EXIT_SUCCESS
                    else repp::cmd::plan::is_blocked "$@"; return $?; fi
                    ;;
                *)
                    echo "Unknown action: $action" >&2
                    repp::help::plan
                    return $REPP_EXIT_ERROR
                    ;;
            esac
            ;;
        --help|-h|"")
            repp::usage
            return $REPP_EXIT_SUCCESS
            ;;
        *)
            echo "Unknown resource: $resource" >&2
            repp::usage
            return $REPP_EXIT_ERROR
            ;;
    esac
}

repp::usage() {
    cat <<EOF
Usage: repp <resource> <action> [args]

Resources:
  plan
    list        List plans
    get         Get plan details
    scan        List plan IDs only
    prioritize  Set plan priority
    review      Transition plan to review
    complete    Transition plan to done
    note        Add comment to plan
    is-blocked  Check if plan is blocked

Run 'repp plan --help' for details.
EOF
}

repp::main "$@"
